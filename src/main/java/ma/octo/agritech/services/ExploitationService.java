package ma.octo.agritech.services;

import ma.octo.agritech.config.IAuthenticationFacade;
import ma.octo.agritech.domains.Exploitation;
import ma.octo.agritech.repositories.ExploitationRepository;
import ma.octo.agritech.repositories.VillageRepository;
import ma.octo.agritech.requests.StoreExploitationRequest;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

@Service
public class ExploitationService {

    @Autowired
    private ExploitationRepository exploitationRepository;

    @Autowired
    private VillageRepository villageRepository;

    @Autowired
    private IAuthenticationFacade authenticationFacade;

    @Autowired
    private UserService userService;

    public List<Exploitation> getAll() {
        List<Exploitation> exploitations = new ArrayList<>();
        this.exploitationRepository.findAll().forEach(exploitations::add);
        return exploitations;
    }


    public Exploitation saveByStoreRequest(StoreExploitationRequest storeExploitationRequest) {

        Exploitation exploitation = new Exploitation();
        exploitation.setRef(storeExploitationRequest.getRef());
        exploitation.setName(storeExploitationRequest.getName());
        exploitation.setArea(storeExploitationRequest.getArea());
        exploitation.setLontitude(storeExploitationRequest.getLontitude());
        exploitation.setLatitude(storeExploitationRequest.getLatitude());
        exploitation.setVillage(this.villageRepository.findOneByRef(storeExploitationRequest.getVillageRef()));

        Authentication authentication = this.authenticationFacade.getAuthentication();
        if (authentication != null) {
            exploitation.setUser(this.userService.getByUsername(authentication.getName()));
        }

        this.exploitationRepository.save(exploitation);
        return exploitation;
    }

//    public List<Exploitation> getAllByVillage(long villageId) {
//        return this.villageRepository.findAllByVillage(villageId);
//    }
}
